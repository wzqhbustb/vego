# performance 优化

核心问题：
经过 Benchmark：Vego 在小规模场景下展现出优秀的查询延迟，但目前还存在召回率问题和并发瓶颈。

## 构建性能分析

1. 算法复杂度分析：
关键发现：
✅ 算法复杂度正确：13.7倍时间 ÷ 10倍数据 ≈ O(N log N) 符合预期
⚠️ 规模化吞吐量下降 27%：从 267 降至 194 个/秒，说明存在性能劣化
🚨 内存分配爆炸：110GB → 1290GB（增长 11.7x），有比较严重的 GC 压力

2. 维度影响：
高维性能下降严重：
维度增加 12倍（128→1536），但吞吐量暴跌 90%
根本原因：
距离计算主导构建时间（符合预期）
缺少 SIMD 优化 - 白白浪费 4-8倍加速潜力
高维向量的内存带宽瓶颈


## 查询性能分析

查询延迟 - 小规模场景优秀 ⭐

关键发现：
✅ 毫秒级 P99 延迟（10K D128）达到生产级别
✅ O(log N) 查询复杂度验证：10K→100K 只增加 1.8倍延迟（非线性）
⚠️ 高维惩罚严重：D1536 比 D128 慢 7.4倍

P99/P50 比值 - 缓存局部性良好
洞察： 低 P99/P50 比值说明性能可预测性强，几乎没有异常长尾请求。


## 并发性能 - 16 核扩展性崩溃

P99 延迟恶化分析：

1 并发：1.32ms
8 并发：1.96ms（1.5倍）
16 并发：13.46ms（10倍！） ← 严重的锁竞争
根本原因：

查询时对 HNSW 图结构使用全局锁
没有实现细粒度锁或无锁算法
建议方案：实现 RCU（读-复制-更新）或分层锁
性能损失量化：

16 核硬件只发挥了 20% 的并行能力
相当于浪费了 80% 的 CPU 资源


## 召回率性能

严重问题剖析
问题 1：10K 场景召回率仅 82.5%

即使 Ef=100 也无法达到 >85% 召回率
说明默认参数配置不合理
问题 2：100K 召回率崩溃至 38.2% 🚨

这是生产阻塞级别的 Bug
说明算法存在根本性缺陷或实现错误
可能原因：
图结构退化（边连接质量下降）
搜索提前终止 Bug
堆管理错误
问题 3：高维场景完全失效（D1536 召回率 43%） 🔴

1536 维是 OpenAI embedding 标准维度，此问题影响主流应用
M=16 参数严重不足（高维推荐 M=32-64）
EfConstruction=200 可能也不够（推荐 400+）
潜在根因（需要逐一排查）：

✅ 参数配置错误：M/EfConstruction 对高维/大规模不适用
⚠️ 搜索算法 Bug：堆操作、提前终止逻辑、距离比较
⚠️ 浮点精度问题：高维距离计算误差累积
⚠️ 图构建质量问题：邻居选择策略不当


## 内存与存储分析

内存分配 - 重大优化机会
测试场景	实际内存	总分配量	分配/内存比
10K D128	15.8 MB	110,447 MB	7,000 倍 🚨
100K D128	103.8 MB	1,289,611 MB	12,424 倍 🚨
严重问题：构建 100K 向量产生 1.29TB 内存分配

问题分析：

每次搜索都创建大量临时对象（候选列表、堆、访问集合）
未使用对象池 (sync.Pool) 复用
导致 GC 压力巨大，吞吐量下降 27%
优化潜力： 引入 sync.Pool 预计可减少 80-90% 分配，提升 20-30% 吞吐量

存储压缩效率 - 良好 ✅
测试场景	原始大小	压缩后	压缩比
10K D128	~6.9 MB	5.79 MB	0.84x ✅
100K D128	~82 MB	63.39 MB	0.77x ✅
10K D1536	~76 MB	59.51 MB	0.78x ✅
分析： 存储格式设计合理，能节省 15-23% 空间，符合预期。

## 修复路线

P0:
问题	影响	修复优先级
100K 召回率 38%	大规模应用完全不可用	URGENT
D1536 召回率 43%	无法支持主流 embedding 模型	URGENT
16 核扩展仅 20%	多核硬件投资浪费 80%	HIGH

召回率 Debug 优先级最高
添加搜索过程日志追踪
与 hnswlib 对比验证算法正确性
逐步排查：参数→算法→精度→图质量

参数自适应调整

并发锁粒度优化
移除全局查询锁
实现节点级读锁或原子操作

P1:
问题	影响	优化方案	预期收益
1.29TB 内存分配	吞吐量损失 27%	引入 sync.Pool	+25-30% 吞吐
无 SIMD 加速	D1536 慢 7.4 倍	AVX512/NEON 优化	+4-8x 距离计算
全局锁竞争	16 核损失 80%	无锁/细粒度锁	+3-4x 并发 QPS


P2 级别（优化打磨）- 长期优化
批量构建索引（减少同步开销）
图遍历预取提示（Cache 友好）
mmap 加载存储文件（减少内存拷贝）
量化支持（PQ/SQ 减少内存占用）